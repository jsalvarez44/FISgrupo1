#include<stdio.h> 
#include<conio.h> 
#include<stdlib.h> 
#include<math.h> 
#include<string.h> 

void comprobar(void);
long int comprobar_1(long int);
void cifrar(void);
void descifrar(void);

long int p,q,n,t,bandera,i;
long int e[100],d[100],temp[100],j,m[100],en[100];
char texto[100];
int primo(long int);
FILE *fp1, *fp2;


main()
{
	fp1 = fopen("C:/clase/cifrar.bin","wb+");
	fp2 = fopen("C:/clase/descifrar.bin","wb+");
	
	printf("\t\t\tPrograma de encriptacion RSA\n\n");
	
	do{
		printf("Ingrese un numero primo P: ");
		scanf("%d",&p);
		bandera=primo(p);
		if(bandera==false)
			printf("Valor ingresado no es un numero primo\n");
	}while(bandera==0);
	
 	do{
		printf("\nIngrese un numero primo Q: ");
		scanf("%d",&q);
		bandera=primo(q);
		if(bandera==false)
			printf("Valor ingresado no es un numero primo\n");	
	}while(bandera==0);
 
	printf("\nIngrese el mensaje para encriptar\n");
 	fflush(stdin);
 	gets(texto);
 	for (i=0;texto[i]!=NULL;i++)
 		m[i]=texto[i];
 
	n=p*q;
 	t=(p-1)*(q-1);
 	
 	comprobar();
 	
 	printf("\nPosibles valores de 'e' y 'd' son: \n");
 	for (i=0;i<j-1;i++)
 	printf("\n%ld\t%ld",e[i],d[i]);
 	cifrar();
 	descifrar(); 	
 	printf("\nMensaje cifrado exitosamente!\n");
 	system("PAUSE");
 	fclose(fp1);
 	fclose(fp2);
 
}
 
int primo(long int pr) 
{ 
	int i;
 	j=sqrt(pr);
 	for (i=2;i<=j;i++) {
 		if(pr%i==0)
 		    return 0;
 	}
 	return 1;
 }

void comprobar(void) 
{
	int k;
	k=0;
	for (i=2;i<t;i++)
	{
		if(t%i==0)
		    continue;
		bandera=primo(i);
		if(bandera==1 && i!=p && i!=q) 
		{
			e[k]=i;
			bandera=comprobar_1(e[k]);
			if(bandera>0) {
				d[k]=bandera;
				k++;
			}
			if(k==99)
			        break;
		}
	}
}
 
long int comprobar_1(long int x) 
{
	long int k=1;
	while(1) {
		k=k+t;
		if(k%x==0)
		    return(k/x);
	}
}

void cifrar(void) 
{
	long int pt,ct,key=e[0],k,len;
	i=0;
	len=strlen(texto);
	while(i!=len) 
	{
		pt=m[i];
		pt=pt-96;
		k=1;
		for (j=0;j<key;j++) {
			k=k*pt;
			k=k%n;
		}
		temp[i]=k;
		ct=k+96;
 		en[i]=ct;
		i++;
 	}
 
	en[i]=-1;
 	//printf("\nEl mensaje cifrado es: \n");
 	for (i=0;en[i]!=-1;i++)
 	putc(en[i],fp1);
 }
 
void descifrar(void) 
{
 	long int pt,ct,key=d[0],k;
 	i=0;
 	while(en[i]!=-1) 
	{
 		ct=temp[i];
 		k=1;
 		for (j=0;j<key;j++) 
		{
 			k=k*ct;
 			k=k%n;
 		}
 		pt=k+96;
 		m[i]=pt;
 		i++;
 	}
 	m[i]=-1;
 	//printf("\nEl mensaje descifrado es: \n");
 	for (i=0;m[i]!=-1;i++)
 	putc(m[i],fp2);
 }
